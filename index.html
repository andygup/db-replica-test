<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Replica</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/esri/css/esri.css">
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS";
        }
        #button-div1{
            position: relative;
            background: #000000;
            color: #ffffff;
            width: 100%;
            height: 40px;
        }
        .right-btn{
            position: relative; float: right;
            padding: 5px;
        }
    </style>
    <script>var dojoConfig = {
        packages: [{
            "name": "modules",
            "location": location.pathname.replace(/\/[^/]+$/, "") + "modules"
        }]
    };
    </script>
    <script src="http://js.arcgis.com/3.8/"></script>
    <script>
        var map;
        var featureLayer0;
        var layersRequest;
        var btnGetReplica,btnSyncReplica;
        var btnUndo,btnRedo;
        var btnGetLayer;
        var undoManager;
        var featureLayer0json;
        var REPLICA_EXTENT_KEY = "replicaExtent";   //for localStorage
        var REPLICA_LAYER_KEY = "replicaLayerKey";  //for localStorage
        var REPLICA_ID_KEY = "replicaId";           //for localStorage
        var REPLICA_USE_EXISTING = true;            //if false then we create a new replica
        var layerDef = {
            "objectIdFieldName": "OBJECTID",
            "globalIdFieldName": "",
            "geometryType": "esriGeometryPoint",
            "spatialReference": {
                "wkid": 102100,
                "latestWkid": 3857
            },
            "fields": [
                {
                    "name": "OBJECTID",
                    "type": "esriFieldTypeOID",
                    "alias": "OBJECTID",
                    "sqlType": "sqlTypeOther",
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "id",
                    "type": "esriFieldTypeInteger",
                    "alias": "id",
                    "sqlType": "sqlTypeOther",
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "brewery_id",
                    "type": "esriFieldTypeInteger",
                    "alias": "brewery_id",
                    "sqlType": "sqlTypeOther",
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "latitude",
                    "type": "esriFieldTypeDouble",
                    "alias": "latitude",
                    "sqlType": "sqlTypeOther",
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "longitude",
                    "type": "esriFieldTypeDouble",
                    "alias": "longitude",
                    "sqlType": "sqlTypeOther",
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "accuracy",
                    "type": "esriFieldTypeString",
                    "alias": "accuracy",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "name",
                    "type": "esriFieldTypeString",
                    "alias": "name",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "address1",
                    "type": "esriFieldTypeString",
                    "alias": "address1",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "address2",
                    "type": "esriFieldTypeString",
                    "alias": "address2",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "city",
                    "type": "esriFieldTypeString",
                    "alias": "city",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "state",
                    "type": "esriFieldTypeString",
                    "alias": "state",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "code",
                    "type": "esriFieldTypeInteger",
                    "alias": "code",
                    "sqlType": "sqlTypeOther",
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "country",
                    "type": "esriFieldTypeString",
                    "alias": "country",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "phone",
                    "type": "esriFieldTypeString",
                    "alias": "phone",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "website",
                    "type": "esriFieldTypeString",
                    "alias": "website",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "descript",
                    "type": "esriFieldTypeString",
                    "alias": "descript",
                    "sqlType": "sqlTypeOther",
                    "length": 255,
                    "domain": null,
                    "defaultValue": null
                },
                {
                    "name": "GlobalID",
                    "type": "esriFieldTypeGlobalID",
                    "alias": "GlobalID",
                    "sqlType": "sqlTypeOther",
                    "length": 38,
                    "domain": null,
                    "defaultValue": null
                }
            ]
        }

        require([
            "esri/map",
            "esri/request",
            "esri/layers/FeatureLayer",
            "esri/undoManager",
            "esri/symbols/PictureMarkerSymbol",
            "dojo/_base/connect",
            "modules/customoperation",
            "dojo/domReady!"],
            function(Map,esriRequest,FeatureLayer,UndoManager,PictureMarkerSymbol,connect,CustomOperation) {
                map = new Map("map", {
                    basemap: "topo",
                    center: [-104.98,39.74], // long, lat
                    zoom: 13,
                    sliderStyle: "small"
                });

                featureLayer0 = new FeatureLayer("http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/OpenBeerDB/FeatureServer/0",{
                     mode: FeatureLayer.MODE_SNAPSHOT,
                     outFields: ["*"]
                });

                featureLayer0.setDefinitionExpression("state = 'Colorado'");

                map.addLayer(featureLayer0);

                featureLayer0.on("load",function(evt){
                    console.log("map loaded");
                    localStorage.setItem(REPLICA_EXTENT_KEY,JSON.stringify(map.extent));
                });

                map.on("click",function(evt){
                    var graphic = new esri.Graphic(evt.mapPoint, markerSymbol);
                    var operation = new CustomOperation.Add({
                        graphicsLayer: featureLayer0,
                        addedGraphic: graphic
                    })

                    undoManager.add(operation);
                    featureLayer0.add(graphic);
                }.bind(this));

                // Create the marker symbol
                var markerSymbol = new PictureMarkerSymbol({
                    "angle":0,
                    "xoffset":0,
                    "yoffset":0,
                    "type":"esriPMS",
                    "url":"images/green-pin.png",
                    "width":35,
                    "height":35
                })

                setupUndoManager();
                setupReplicaListeners();

                function setupReplicaListeners(){
                    btnGetReplica = document.getElementById("btn-get-replica");
                    btnSyncReplica = document.getElementById("btn-sync-replica");
                    btnGetLayer = document.getElementById("btn-get-layer");

                    btnGetReplica.onclick = function(evt){
                        createReplica();
                    }.bind(this)

                    btnGetLayer.onclick = function(evt){
                        loadReplica();
                    }.bind(this)

                    btnSyncReplica.onclick = function(evt){
                        var edits = getUndoMgrGraphic();
                        var replicaJson = JSON.stringify(createUpdateReplicaJSON(edits));
                        var unescapedJson = replicaJson.replace(/\\"/g, '');
                        console.log("replicaJSON to be committed: " + unescapedJson)
                        synchronizeReplica(unescapedJson);
                    }.bind(this)
                }

                function setupUndoManager(){
                    undoManager = new UndoManager();
                    undoManager.canRedo = true;
                    undoManager.canUndo = true;

                    btnRedo = document.getElementById("btn-redo");
                    btnUndo = document.getElementById("btn-undo");

                    btnRedo.onclick = function(evt){
                        undoManager.redo();
                    }.bind(this)

                    btnUndo.onclick = function(evt){
                        undoManager.undo();
                    }.bind(this)

                    connect.connect(undoManager,"onChange",function(){
                        //enable or disable buttons depending on current state of application
                        if (undoManager.canUndo) {
                            btnUndo.disabled = false;
                        } else {
                            btnUndo.disabled = true;
                        }

                        if (undoManager.canRedo) {
                            btnRedo.disabled = false;
                        } else {
                            btnRedo.disabled = true;
                        }
                    });
                }

                function createReplica(){
                    var extent = map.extent.xmin + "," + map.extent.ymin + "," + map.extent.xmax + "," + map.extent.ymax;
                    var layerUrl = "http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/OpenBeerDB/FeatureServer/createReplica";
                    var layersRequest = esriRequest({
                        url: layerUrl,
                        content: {
                            f: "json",
                            layers:"0",
                            geometry:extent,
                            geometryType:"esriGeometryEnvelope",
                            inSR:"102100",
                            transportType: "esriTransportTypeEmbedded",
                            returnAttachments:true
                        },
                        handleAs: "json",
                        callbackParamName: "callback"
                    },{usePost:true});
                    layersRequest.then(
                            function(response) {
                                handleCreateReplicaSuccess(response);
                            }, function(error) {
                                console.log("Error: ", JSON.stringify(error));
                            });
                }

                function synchronizeReplica(edits){

                    var replica = JSON.parse(localStorage.replicaLayer0);
                    var serverGen = JSON.stringify(replica.layerServerGens[0]);
                    var syncLayers =  (JSON.stringify([replica.layerServerGens[0]])).replace(/\\"/g, '')

                    var extent = map.extent.xmin + "," + map.extent.ymin + "," + map.extent.xmax + "," + map.extent.ymax;
                    var layerUrl = "http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/OpenBeerDB/FeatureServer/synchronizeReplica";
                    //replica.layerServerGens[0].serverGen
                    var layersRequest = esriRequest({
                        url: layerUrl,
                        content: {
                            f: "json",
                            replicaID:replica.replicaID,
                            replicaServerGen:"2013",
                            syncLayers: "[{'id':0,'serverGen':2013}]",
                            "syncDirection": "bidirectional",
                            "dataFormat":"json",
                            "async": "false",
                            closeReplica:"false",
                            returnIdsForAdds:"true",
                            "returnAttachmentsDataByUrl": "false",
                            "returnIdsForAdds": "true",
                            "rollbackOnFailure": "true",
                            "editsUploadId": "",
                            "editsUploadFormat":"json",
                            "token":"",
                            transportType: "esriTransportTypeEmbedded",
                            edits: edits
                        },
                        handleAs: "json",
                        callbackParamName: "callback"
                    },{usePost:true});
                    layersRequest.then(
                            function(response) {
                                console.log("sync replica: " + JSON.stringify(response))
                                alert("sync replica success: " + JSON.stringify(response))
                            }, function(error) {
                                console.log("sync replica error: ", JSON.stringify(error));
                            });
                }

                function getReplica(){

                    var gExtent = JSON.parse(localStorage.getItem(REPLICA_EXTENT_KEY));
                    var extent = gExtent.xmin + "," + gExtent.ymin + "," + gExtent.xmax + "," + gExtent.ymax;
                    var layerUrl = "http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/OpenBeerDB/FeatureServer/replicas";
                    //replica.layerServerGens[0].serverGen
                    var layersRequest = esriRequest({
                        url: layerUrl,
                        handleAs: "json",
                        callbackParamName: "callback"
                    },{usePost:false});
                    layersRequest.then(
                            function(response) {
                                console.log("Get list of replicas: " + JSON.stringify(response))
                            }, function(error) {
                                console.log("Get list of replicas error: ", JSON.stringify(error));
                            });
                }

                function getUndoMgrGraphic(){
                    var graphic = undoManager._historyStack[0]._addedGraphic;
                    graphic.attributes = {
                        "ObjectId":6669,
                        "GlobalID":"9d4d2b23-9ba0-4d0c-a895-3667098ea9a8",
                        "CreationDate":1395953482000,
                        "Creator":"",
                        "EditDate": 1395953482000,
                        "Editor": "",
                        "id":"10000",
                        "brewery_id" : null,
                        "latitude" : 30.22340012,
                        "longitude" : -97.7696991,
                        "accuracy" : "ROOFTOP",
                        "name" : "(512) Brewing Company",
                        "address1" : "407 Radam, F200",
                        "address2" : "",
                        "city" : "Austin",
                        "state" : "Texas",
                        "code" : 78745,
                        "country" : "United States",
                        "phone" : "512.707.2337",
                        "website" : "",
                        "descript" : "(512) Brewing Company is a microbrewery located in the heart of Austin that brews for the community using as many local, domestic and organic ingredients as possible."
                    }

                    return graphic.toJson();
                }

                function handleCreateReplicaSuccess(response){
                    localStorage.replicaLayer0 = JSON.stringify(response);
                    console.log("Success: ", response.layers);
                    alert("Replica retrieved successfully");
                }

                function loadReplica(){
                    var t = JSON.parse(localStorage.replicaLayer0);
                    var featureDefinition = {
                        "layerDefinition":layerDef,
                        "featureSet":{
                            "features": t.layers[0].features,
                            "geometryType": "esriGeometryPoint"
                        }

                    }

                    featureLayer0 = new FeatureLayer(featureDefinition);
                    map.addLayer(featureLayer0);
                }

                function createUpdateReplicaJSON(edits){
                   return [{"id" : 0,
                       "features":{
                           "adds":[
                            edits
                           ],
                           "updates":[],
                           "deleteIds":[]
                       }

                   }]
                }

                function isLocalStorage(){
                    if(typeof(Storage)!=="undefined"){
                        return true;
                    }
                    else{
                        return false;
                    }


                }
            }
        );
    </script>
</head>

<body>
<div id="button-div1">
    <button id="btn-get-replica">1. Get Replica</button>
    <button id="btn-get-layer">2. Add Replica to map</button>
    <button>3. Click here then click on map</button>
    <button id="btn-sync-replica">4. Sync Replica</button>

    <button class="right-btn" id="btn-undo">Undo</button>
    <button class="right-btn" id="btn-redo">Redo</button>

</div>
<div id="map"></div>
</body>
</html>